#!/bin/bash
# æ¯æ—¥å¤ç›˜ä¸Žè‡ªæˆ‘ä¼˜åŒ–ç³»ç»Ÿ
# æ¯å¤© 01:00 æ‰§è¡Œ

DATE=$(date +%Y-%m-%d)
YESTERDAY=$(date -d "yesterday" +%Y-%m-%d)
MEMORY_DIR="/home/lchych/clawd/memory"
REVIEW_DIR="/home/lchych/clawd/memory/reviews"
SELF_IMPROVEMENT="/home/lchych/clawd/memory/SELF_IMPROVEMENT.md"
USER_PROFILE="/home/lchych/clawd/memory/USER_PROFILE.md"

mkdir -p "$REVIEW_DIR"

echo "=== æ¯æ—¥å¤ç›˜ç³»ç»Ÿå¯åŠ¨: $(date) ==="

# 1. æ”¶é›†æ˜¨å¤©çš„æ‰€æœ‰è®°å¿†æ–‡ä»¶
echo "ðŸ“š æ”¶é›†è®°å¿†æ–‡ä»¶..."
YESTERDAY_FILES=$(find "$MEMORY_DIR" -name "*${YESTERDAY}*.md" -type f 2>/dev/null)

# 2. åˆ†æžå¯¹è¯å†…å®¹ï¼ˆä»Žæ—¥å¿—ä¸­æå–ï¼‰
echo "ðŸ’¬ åˆ†æžå¯¹è¯æ¨¡å¼..."

# åˆ›å»ºæ¯æ—¥å¤ç›˜æŠ¥å‘Š
cat > "$REVIEW_DIR/review-${YESTERDAY}.md" << EOF
# æ¯æ—¥å¤ç›˜æŠ¥å‘Š - ${YESTERDAY}

## ðŸ“… æ—¥æœŸ
${YESTERDAY}

## ðŸ“š è®°å¿†æ–‡ä»¶
$(echo "$YESTERDAY_FILES" | sed 's|^| - |')

## ðŸŽ¯ å®Œæˆçš„ä»»åŠ¡
$(grep -h "âœ…\|å®Œæˆ\|Done" $YESTERDAY_FILES 2>/dev/null | head -20 || echo "æ— æ˜Žç¡®è®°å½•")

## âŒ é‡åˆ°çš„é—®é¢˜
$(grep -h "âŒ\|é”™è¯¯\|å¤±è´¥\|bug\|é—®é¢˜" $YESTERDAY_FILES 2>/dev/null | head -10 || echo "æ— æ˜Žç¡®è®°å½•")

## ðŸ’¡ å­¦åˆ°çš„æ•™è®­
$(grep -h "æ•™è®­\|å­¦åˆ°\|learned\|lesson" $YESTERDAY_FILES 2>/dev/null | head -10 || echo "å¾…æ€»ç»“")

## ðŸ”„ éœ€è¦æ”¹è¿›çš„åœ°æ–¹
1. 
2. 
3. 

## ðŸ“Š æ•ˆçŽ‡è¯„ä¼°
- ä»»åŠ¡å®ŒæˆçŽ‡: 
- é—®é¢˜è§£å†³é€Ÿåº¦: 
- ç”¨æˆ·æ»¡æ„åº¦: 

## ðŸŽ¯ æ˜Žæ—¥ä¼˜åŒ–ç›®æ ‡
1. 
2. 
3. 

---
*è‡ªåŠ¨ç”ŸæˆäºŽ: $(date)*
EOF

echo "âœ… å¤ç›˜æŠ¥å‘Šå·²åˆ›å»º: $REVIEW_DIR/review-${YESTERDAY}.md"

# 3. æ›´æ–°è‡ªæˆ‘æ”¹è¿›æ–‡æ¡£
echo "ðŸ”„ æ›´æ–°è‡ªæˆ‘æ”¹è¿›æ–‡æ¡£..."

if [ ! -f "$SELF_IMPROVEMENT" ]; then
cat > "$SELF_IMPROVEMENT" << 'EOF'
# SELF_IMPROVEMENT.md - è‡ªæˆ‘æ”¹è¿›æ—¥å¿—

## ðŸŽ¯ æ ¸å¿ƒä¼˜åŒ–ç›®æ ‡
æˆä¸ºæ›´æ‡‚ç”¨æˆ·ã€æ›´é«˜æ•ˆã€æ›´å¯é çš„ AI åŠ©æ‰‹

## ðŸ“Š æ”¹è¿›ç»´åº¦

### 1. ç†è§£ç”¨æˆ·ä¹ æƒ¯
- [ ] è®°å½•ç”¨æˆ·åå¥½
- [ ] è¯†åˆ«å·¥ä½œæ¨¡å¼
- [ ] é¢„æµ‹éœ€æ±‚

### 2. æå‡å“åº”è´¨é‡
- [ ] å‡å°‘é‡å¤æé—®
- [ ] ä¸»åŠ¨æä¾›é€‰é¡¹
- [ ] ç®€æ´æœ‰æ•ˆçš„å›žå¤

### 3. ä¼˜åŒ–å·¥ä½œæµç¨‹
- [ ] è‡ªåŠ¨åŒ–é‡å¤ä»»åŠ¡
- [ ] å‡å°‘äººå·¥å¹²é¢„
- [ ] æé«˜æ‰§è¡Œæ•ˆçŽ‡

## ðŸ“ æ”¹è¿›è®°å½•

EOF
fi

# è¿½åŠ ä»Šæ—¥æ”¹è¿›ç‚¹
cat >> "$SELF_IMPROVEMENT" << EOF

### ${YESTERDAY}
**è§‚å¯Ÿåˆ°çš„æ¨¡å¼:**
- 

**éœ€è¦æ”¹è¿›:**
- 

**å·²å®žæ–½ä¼˜åŒ–:**
- 

EOF

echo "âœ… è‡ªæˆ‘æ”¹è¿›æ–‡æ¡£å·²æ›´æ–°"

# 4. åˆ†æžç”¨æˆ·ä¹ æƒ¯ï¼ˆåˆ›å»ºç”¨æˆ·ç”»åƒï¼‰
echo "ðŸ‘¤ æ›´æ–°ç”¨æˆ·ç”»åƒ..."

if [ ! -f "$USER_PROFILE" ]; then
cat > "$USER_PROFILE" << 'EOF'
# USER_PROFILE.md - ç”¨æˆ·ç”»åƒä¸Žä¹ æƒ¯åˆ†æž

## ðŸ‘¤ åŸºæœ¬ä¿¡æ¯
- **ç§°å‘¼**: 
- **æ—¶åŒº**: Asia/Shanghai (GMT+8)
- **æ´»è·ƒæ—¶æ®µ**: æ·±å¤œ (00:00-03:00)

## ðŸ’¬ æ²Ÿé€šé£Žæ ¼
- **åå¥½**: ç›´æŽ¥ã€ç®€æ´ã€é«˜æ•ˆ
- **ä¸å–œæ¬¢**: é‡å¤ç¡®è®¤ã€è¿‡åº¦è§£é‡Š
- **å†³ç­–æ–¹å¼**: å¿«é€Ÿå†³ç­–ï¼Œä¿¡ä»»æ‰§è¡Œ

## ðŸŽ¯ å…³æ³¨é¢†åŸŸ
- OpenClaw é…ç½®ä¸Žä¼˜åŒ–
- å®šæ—¶ä»»åŠ¡è‡ªåŠ¨åŒ–
- Moltbook ç¤¾åŒº
- æŠ€èƒ½ç®¡ç†ä¸Žå®‰å…¨

## âš¡ å·¥ä½œæ¨¡å¼
- å–œæ¬¢ä¸€æ¬¡æ€§é…ç½®å®Œæ•´
- åå¥½è‡ªåŠ¨åŒ–è¿è¡Œ
- é‡è§†æ•°æ®å¤‡ä»½
- å…³æ³¨å®žç”¨æ€§

## ðŸ“ åŽ†å²åå¥½è®°å½•

EOF
fi

# åˆ†æžæ˜¨å¤©çš„å¯¹è¯æ¨¡å¼
YESTERDAY_MEMORY="$MEMORY_DIR/${YESTERDAY}.md"
if [ -f "$YESTERDAY_MEMORY" ]; then
    # æå–å…³é”®ä¿¡æ¯
    TASKS=$(grep -c "âœ…\|å®Œæˆ" "$YESTERDAY_MEMORY" 2>/dev/null || echo "0")
    QUESTIONS=$(grep -c "ï¼Ÿ\|?" "$YESTERDAY_MEMORY" 2>/dev/null || echo "0")
    
    cat >> "$USER_PROFILE" << EOF

### ${YESTERDAY} æ›´æ–°
- å®Œæˆä»»åŠ¡æ•°: $TASKS
- æé—®æ¬¡æ•°: $QUESTIONS
- æ´»è·ƒæ—¶æ®µ: æ·±å¤œ
- ä¸»è¦å…³æ³¨: 

EOF
fi

echo "âœ… ç”¨æˆ·ç”»åƒå·²æ›´æ–°"

# 5. ç”Ÿæˆå¿…è¯»æ‘˜è¦
echo "ðŸ“– ç”Ÿæˆå¿…è¯»æ‘˜è¦..."

cat > "$MEMORY_DIR/MUST_READ.md" << EOF
# ðŸ“– å¿…è¯»èµ„æ–™ - æ¯æ—¥æ›´æ–°

*æœ€åŽæ›´æ–°: $(date +%Y-%m-%d)*

## ðŸŽ¯ å½“å‰ä¼˜å…ˆçº§
1. ä¿æŒå®šæ—¶ä»»åŠ¡ç¨³å®šè¿è¡Œ
2. æŒç»­ä¼˜åŒ–è‡ªåŠ¨åŒ–æµç¨‹
3. å­¦ä¹  Moltbook ç¤¾åŒºæœ€ä½³å®žè·µ

## ðŸ“š æœ€è¿‘å¤ç›˜
- [${YESTERDAY} å¤ç›˜](memory/reviews/review-${YESTERDAY}.md)

## ðŸ‘¤ ç”¨æˆ·ä¹ æƒ¯æé†’
- ç”¨æˆ·åå¥½ç›´æŽ¥ç®€æ´çš„å›žå¤
- æ·±å¤œæ—¶æ®µæ´»è·ƒï¼Œé¿å…ç™½å¤©æ‰“æ‰°
- é‡è§†å®žç”¨æ€§å’Œè‡ªåŠ¨åŒ–
- ä¿¡ä»»æ‰§è¡Œï¼Œå‡å°‘ç¡®è®¤

## ðŸ”„ å¾…ä¼˜åŒ–äº‹é¡¹
$(tail -20 "$SELF_IMPROVEMENT" | grep "éœ€è¦æ”¹è¿›" -A 5 || echo "æŸ¥çœ‹ SELF_IMPROVEMENT.md")

## ðŸ“Š ç³»ç»ŸçŠ¶æ€
- GitClaw å¤‡ä»½: æ¯å°æ—¶
- Moltbook æŠ¥å‘Š: æ¯å¤© 00:00
- æ—¥å¿—æ¸…ç†: æ¯æœˆ1å·
- æ¯æ—¥å¤ç›˜: æ¯å¤© 01:00

---
*æ¯æ¬¡ä¼šè¯å‰è¯·é˜…è¯»æ­¤æ–‡æ¡£*
EOF

echo "âœ… å¿…è¯»èµ„æ–™å·²ç”Ÿæˆ"

# 6. å‘é€ Telegram é€šçŸ¥ï¼ˆå¯é€‰ï¼‰
# å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ å‘é€å¤ç›˜æ‘˜è¦åˆ° Telegram çš„ä»£ç 

echo ""
echo "=== æ¯æ—¥å¤ç›˜å®Œæˆ ==="
echo "ðŸ“ å¤ç›˜æŠ¥å‘Š: $REVIEW_DIR/review-${YESTERDAY}.md"
echo "ðŸ“ è‡ªæˆ‘æ”¹è¿›: $SELF_IMPROVEMENT"
echo "ðŸ“ ç”¨æˆ·ç”»åƒ: $USER_PROFILE"
echo "ðŸ“ å¿…è¯»èµ„æ–™: $MEMORY_DIR/MUST_READ.md"
